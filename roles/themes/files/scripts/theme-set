#!/bin/bash
# Theme switcher for Hyprland
# Usage: theme-set <theme-name>

source "$HOME/.local/share/dotfiles/bin/helpers.sh"

THEMES_DIR="$HOME/.local/share/dotfiles/themes"
CURRENT_THEME_LINK="$HOME/.local/share/dotfiles/current/theme"
CURRENT_BACKGROUND_LINK="$HOME/.local/share/dotfiles/current/background"

list_themes() {
    echo "Available themes:"
    for theme in "$THEMES_DIR"/*/; do
        theme_name=$(basename "$theme")
        if [[ -L "$CURRENT_THEME_LINK" ]] && [[ "$(readlink "$CURRENT_THEME_LINK")" == *"$theme_name"* ]]; then
            echo "  * $theme_name (active)"
        else
            echo "    $theme_name"
        fi
    done
}

set_wallpaper() {
    local wallpaper="$1"
    ln -snf "$wallpaper" "$CURRENT_BACKGROUND_LINK"

    # Reload hyprpaper
    if command -v hyprctl &> /dev/null; then
        hyprctl hyprpaper reload ",$CURRENT_BACKGROUND_LINK" 2>/dev/null || true
    fi
    log_success "Wallpaper set: $(basename "$wallpaper")"
}

reload_apps() {
    log_step "Reloading applications..."

    # Reload Hyprland
    if command -v hyprctl &> /dev/null; then
        hyprctl reload 2>/dev/null || true
    fi

    # Reload waybar
    if pgrep -x waybar > /dev/null; then
        pkill -x waybar
        sleep 0.3
        waybar &
        disown
    fi

    # Reload mako
    if command -v makoctl &> /dev/null; then
        makoctl reload 2>/dev/null || true
    fi

    # Reload swayosd
    if pgrep -x swayosd-server > /dev/null; then
        pkill -x swayosd-server
        sleep 0.3
        swayosd-server &
        disown
    fi

    # Signal btop to reload
    pkill -SIGUSR2 btop 2>/dev/null || true

    # Signal ghostty to reload
    pkill -SIGUSR2 ghostty 2>/dev/null || true

    log_success "Applications reloaded"
}

switch_theme() {
    local theme_name="$1"

    # Normalize theme name
    theme_name=$(echo "$theme_name" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

    local theme_path="$THEMES_DIR/$theme_name"

    if [[ ! -d "$theme_path" ]]; then
        log_error "Theme '$theme_name' not found"
        echo ""
        list_themes
        return 1
    fi

    log_step "Switching to theme: $theme_name"

    # Update theme symlink
    ln -snf "$theme_path" "$CURRENT_THEME_LINK"

    # Set first wallpaper from theme
    local wallpaper=$(find -L "$theme_path/backgrounds" -type f 2>/dev/null | sort | head -n 1)
    if [[ -n "$wallpaper" ]]; then
        set_wallpaper "$wallpaper"
    fi

    reload_apps
    log_success "Theme switched to: $theme_name"
}

show_help() {
    echo "Usage: theme-set <theme-name>"
    echo ""
    echo "Commands:"
    echo "  theme-set <name>       Switch to specified theme"
    echo "  theme-set --list       List available themes"
    echo "  theme-set --help       Show this help"
    echo ""
    list_themes
}

main() {
    case "$1" in
        --list|-l)
            list_themes
            ;;
        --help|-h|"")
            show_help
            ;;
        *)
            switch_theme "$1"
            ;;
    esac
}

main "$@"
