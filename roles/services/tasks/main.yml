---
# Systemd services configuration

- name: Reload systemd daemon
  become: true
  systemd:
    daemon_reload: true

- name: Check if bluetooth service exists
  shell: systemctl list-unit-files bluetooth.service
  register: bluetooth_exists
  changed_when: false
  failed_when: false

- name: Enable bluetooth service
  become: true
  systemd:
    name: bluetooth
    enabled: true
    state: started
  when: bluetooth_exists.rc == 0

- name: Enable pipewire user services
  systemd:
    name: "{{ item }}"
    enabled: true
    scope: user
    state: started
  loop:
    - pipewire.service
    - pipewire-pulse.service
    - wireplumber.service
  failed_when: false

- name: Check if power-profiles-daemon exists
  shell: systemctl list-unit-files power-profiles-daemon.service
  register: ppd_exists
  changed_when: false
  failed_when: false

- name: Enable power-profiles-daemon
  become: true
  systemd:
    name: power-profiles-daemon
    enabled: true
    state: started
  when: ppd_exists.rc == 0

- name: Check if ufw is installed
  shell: command -v ufw
  register: ufw_exists
  changed_when: false
  failed_when: false

- name: Configure firewall (ufw)
  become: true
  when: ufw_exists.rc == 0
  block:
    - name: Set ufw default deny incoming
      ufw:
        direction: incoming
        policy: deny

    - name: Set ufw default allow outgoing
      ufw:
        direction: outgoing
        policy: allow

    - name: Enable ufw
      ufw:
        state: enabled

- name: Check if plocate timer exists
  shell: systemctl list-unit-files plocate-updatedb.timer
  register: plocate_exists
  changed_when: false
  failed_when: false

- name: Enable plocate timer
  become: true
  systemd:
    name: plocate-updatedb.timer
    enabled: true
    state: started
  when: plocate_exists.rc == 0

- name: Check if PAM login file exists
  stat:
    path: /etc/pam.d/login
  register: pam_login

- name: Configure PAM for gnome-keyring
  become: true
  lineinfile:
    path: /etc/pam.d/login
    line: "auth       optional     pam_gnome_keyring.so"
    insertafter: "auth"
  when: pam_login.stat.exists

- name: Configure PAM session for gnome-keyring
  become: true
  lineinfile:
    path: /etc/pam.d/login
    line: "session    optional     pam_gnome_keyring.so auto_start"
    insertafter: "session"
  when: pam_login.stat.exists

- name: Check if greetd exists
  shell: systemctl list-unit-files greetd.service
  register: greetd_exists
  changed_when: false
  failed_when: false

- name: Configure greetd
  become: true
  copy:
    dest: /etc/greetd/config.toml
    content: |
      [terminal]
      vt = 1

      [default_session]
      command = "tuigreet --time --remember --remember-session --sessions /usr/share/wayland-sessions"
      user = "greeter"
    mode: '0644'
  when: greetd_exists.rc == 0

- name: Remove existing display-manager symlink
  become: true
  file:
    path: /etc/systemd/system/display-manager.service
    state: absent
  when: greetd_exists.rc == 0

- name: Enable greetd display manager
  become: true
  systemd:
    name: greetd
    enabled: true
  when: greetd_exists.rc == 0

- name: Display services notice
  debug:
    msg: |
      Services configured:
        - Bluetooth: enabled
        - Pipewire audio: enabled
        - Power profiles: enabled
        - Firewall (ufw): enabled with default deny
        - File indexing (plocate): enabled
        - GNOME Keyring: configured
        - greetd display manager: enabled

      REBOOT YOUR SYSTEM to start the graphical login!
      Use arrow keys to select 'Hyprland' session in tuigreet.
